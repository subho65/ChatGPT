<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
    <link rel="icon" type="image/png" href="dark.png" id="favicon">
    <title>ChatBHO</title>
    <style>
        :root,
        [data-theme="dark"] {
            --bg-primary: #141c2f;
            --bg-secondary: #1e2a44;
            --accent: #00b7ff;
            --text-primary: #d9e1e8;
            --text-secondary: #8a94a6;
            --user-bubble: #0066cc;
            --assistant-bubble: #2a3555;
            /* Fixed typo from --assistant-bV */
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            --radius: 0.8rem;
            --input-border: #3a4666;
            --code-bg: #1a233b;
            --separator: #2e3b5a;
            --error-color: #ff6b6b;
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --accent: #007bff;
            --text-primary: #1a2a44;
            --text-secondary: #6b7280;
            --user-bubble: #007bff;
            --assistant-bubble: #e5e7eb;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --radius: 0.8rem;
            --input-border: #d1d5db;
            --code-bg: #f3f4f6;
            --separator: #d1d5db;
            --error-color: #e53e3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: "Arial", sans-serif;
            overflow-y: auto;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            width: 90%;
            max-width: 900px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            font-size: clamp(1.5rem, 4vw, 2rem);
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            font-weight: 600;
            position: relative;
            border-bottom: 1px solid var(--separator);
        }

        .info-button,
        .delete-button {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .info-button:hover,
        .delete-button:hover {
            color: var(--accent);
            transform: translateY(-50%) scale(1.1);
        }

        .info-button {
            left: 1rem;
        }

        .delete-button {
            right: 1rem;
        }

        .chat-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }

        .chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .user-message,
        .assistant-message {
            max-width: fit-content;
            min-width: 10%;
            font-size: clamp(0.9rem, 2vw, 1rem);
            line-height: 1.5;
            padding: 0.8rem 1.3rem;
            margin: 0.6rem 0;
            border-radius: var(--radius);
            word-wrap: break-word;
            box-shadow: var(--shadow);
        }

        .user-message {
            background: var(--user-bubble);
            color: #fff;
            margin-left: auto;
        }

        .assistant-message {
            background: var(--assistant-bubble);
            color: var(--text-primary);
            margin-right: auto;
        }

        .assistant-message .typing {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9em;
            background: none;
            padding: 0;
            margin: 0;
        }

        .assistant-message:empty {
            display: none;
        }

        .katex {
            display: inline-block;
            vertical-align: middle;
            margin: 0 0.2rem;
            padding: 0;
        }

        .katex-display {
            display: block;
            margin: 0.5rem 0;
            text-align: center;
            padding: 0;
            line-height: 1.2;
        }

        .katex-display>.katex {
            display: inline-block;
        }

        .katex-html {
            line-height: 1.2;
            white-space: normal;
        }

        .math-error {
            color: var(--error-color);
            font-style: italic;
        }

        .input-container {
            width: 100%;
            background: var(--bg-primary);
            padding: 0.8rem 1rem;
            border-top: 1px solid var(--separator);
            display: flex;
            align-items: center;
            z-index: 10;
        }

        input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: clamp(0.9rem, 2vw, 1rem);
            padding: 0.6rem 1rem;
            outline: none;
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        input:focus {
            border-color: var(--accent);
            background: [data-theme="dark"] ? #253054: #f0f4f8;
        }

        #sendButton {
            background: var(--accent);
            border: none;
            color: #fff;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease-in-out;
        }

        #sendButton:hover {
            background: [data-theme="dark"] ? #0099d6: #0056b3;
            transform: scale(1.1);
        }

        #sendButton:active {
            transform: scale(1);
        }

        pre {
            background: var(--code-bg);
            color: [data-theme="dark"] ? #dcdcdc: #1a2a44;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
        }

        code {
            color: [data-theme="dark"] ? #dcdcdc: #1a2a44;
        }

        .separator {
            border-top: 1px solid var(--separator);
            margin: 1rem 0;
        }

        .typing::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            /* Default fallback */
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        /* Dark theme */
        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Light theme */
        [data-theme="light"] .modal {
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal img {
            width: 100%;
            border-radius: 0.5rem;
            max-height: 80vh;
        }

        .close-btn,
        .download-btn {
            position: absolute;
            top: 1rem;
            color: var(--text-primary);
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .close-btn:hover,
        .download-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        .close-btn {
            right: 1rem;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }

        .download-btn {
            right: 3rem;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1rem;
            margin-top: 1vh;
            opacity: 0;
            animation: fadeIn 2s forwards;
        }

        .help {
            font-size: clamp(2rem, 4vw, 2rem);
            text-align: center;
            color: var(--text-primary);
            margin: 15vh 0 2rem;
            font-weight: 600;
        }

        .button {
            background: var(--assistant-bubble);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            border-radius: 2rem;
            padding: clamp(0.6rem, 2vw, 0.8rem) clamp(1rem, 3vw, 1.2rem);
            font-size: clamp(0.85rem, 2vw, 1rem);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .button i {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
        }

        .button:nth-child(1) i {
            color: #00cc66;
        }

        .button:nth-child(2) i {
            color: #ff3366;
        }

        .button:nth-child(3) i {
            color: #3366ff;
        }

        .button:nth-child(4) i {
            color: #00cccc;
        }

        .button:nth-child(5) i {
            color: #ff9900;
        }

        .button:nth-child(6) i {
            color: #ccff33;
        }

        .button:nth-child(7) i {
            color: #33cccc;
        }

        .button:nth-child(8) i {
            color: #ff6633;
        }

        .button:nth-child(9) i {
            color: #ff0000;
        }

        .button:hover {
            background: [data-theme="dark"] ? #344066: #d1d5db;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            .container {
                width: 100%;
                height: 100vh;
            }

            .chat-area {
                padding: 1rem;
                padding-bottom: 70px;
                /* Space for fixed input bar */
            }

            .input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                padding: 0.6rem;
            }

            img.generated-image {
                width: 80%;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }

        }

        img.generated-image {
            width: 50%;
            border-radius: 10px;
            margin-top: 15px;
        }

        /* Existing Modal Styles (keep these) */
        #infoModal,
        #deleteModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] #infoModal,
        [data-theme="dark"] #deleteModal {
            background: rgba(0, 0, 0, 0.9);
        }

        [data-theme="light"] #infoModal,
        [data-theme="light"] #deleteModal {
            background: rgba(0, 0, 0, 0.7);
        }

        /* Updated Info Modal Content Styles */
        .info-modal-content,
        .delete-modal-content {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius);
            width: 90%;
            /* Default for smaller screens */
            max-width: 500px;
            /* Default max-width for mobile */
            box-shadow: var(--shadow);
            position: relative;
            color: var(--text-primary);
            max-height: 80vh;
            /* Limit height to 80% of viewport height */
            overflow-y: auto;
            /* Enable vertical scrolling */
        }

        /* Media Query for Laptops (wider modal) */
        @media (min-width: 768px) {

            .info-modal-content,
            .delete-modal-content {
                width: 70%;
                /* Wider on larger screens */
                max-width: 800px;
                /* Increased max-width for laptops */
            }
        }

        /* Rest of your modal styles remain unchanged */
        .info-modal-content h2,
        .delete-modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .info-modal-content h3 {
            font-size: 1.2rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .info-modal-content p,
        .delete-modal-content p {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .info-modal-content ul {
            font-size: 0.9rem;
            line-height: 1.4;
            padding-left: 20px;
            text-align: justify;
            margin-bottom: 1rem;
        }

        .info-modal-content ul li {
            margin-bottom: 0.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-button {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .modal-button:hover {
            background: #0099d6;
        }

        .modal-button.cancel {
            background: var(--error-color);
        }

        .modal-button.cancel:hover {
            background: #e53e3e;
        }

        .close-info-btn,
        .close-delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .close-info-btn:hover,
        .close-delete-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        .header-logo {
            width: auto;
            /* Adjust size as needed */
            height: 40px;
            margin-right: 0.5rem;
            /* Space between logo and text */
            border-radius: none;
            /* Optional: makes it circular */
            vertical-align: middle;
            /* Aligns with text */
        }

        [data-theme="dark"] .header-logo {
    content: url("dark.png"); /* Light logo for dark mode */
}

/* Light mode logo */
[data-theme="light"] .header-logo {
    content: url("light.png"); /* Dark logo for light mode */
}

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="info-button" onclick="showInfo()"><i class="fas fa-info-circle"></i></button>
            <img src="dark.png" alt="ChatBHO Logo" class="header-logo">
            ChatBHO
            <button class="delete-button" onclick="confirmDeletion()"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div class="chat-area" id="messages">
            <div class="help" id="helpText"></div>
            <div class="main-container" id="mainContainer">
                <button class="button" onclick="buttonAction('Create image')"><i class="fas fa-image"></i> Create
                    image</button>
                <button class="button" onclick="buttonAction('Help me write')"><i class="fas fa-pen"></i> Help me
                    write</button>
                <button class="button" onclick="buttonAction('Code')"><i class="fas fa-code"></i> Code</button>
                <button class="button" onclick="buttonAction('Meaning')"><i class="fa-solid fa-language"></i>
                    Meaning</button>
                <button class="button" onclick="buttonAction('Spell Check')"><i class="fa-solid fa-spell-check"></i>
                    Spell Check</button>
                <button class="button" onclick="buttonAction('Get advice')"><i class="fas fa-graduation-cap"></i> Get
                    advice</button>
                <button class="button" onclick="buttonAction('Summarize text')"><i class="fas fa-file-alt"></i>
                    Summarize text</button>
                <button class="button" onclick="buttonAction('Do Math')"><i class="fas fa-calculator"></i> Do
                    Math</button>
                <button class="button" onclick="buttonAction('Switch Theme')"><i
                        class="fa-solid fa-circle-half-stroke"></i>Switch Theme</button>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="inputField" placeholder="Message ChatBHO">
            <button id="sendButton" onclick="handleUserMessage()"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>
    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()"><i class="fa-solid fa-circle-xmark"></i></span>
            <span id="downloadLink" class="download-btn" onclick="downloadImage()"><i
                    class="fas fa-download"></i></span>
            <img id="modalImage" alt="Generated image">
        </div>
    </div>

    <!-- New Info Modal -->
    <!-- New Info Modal with Expanded Content -->
    <div id="infoModal" class="modal">
        <div class="info-modal-content">
            <span class="close-info-btn" onclick="closeInfoModal()"><i class="fa-solid fa-circle-xmark"></i></span>
            <h2>Welcome to ChatBHO!</h2>
            <p>ChatBHO is your versatile virtual assistant designed to assist with a wide range of tasks. Here’s how to
                get
                started and make the most of its capabilities:</p>
            <h3>Key Features</h3>
            <ul>
                <li><strong>Image Generation</strong>: Use <code>/imagine</code> followed by a description (e.g.,
                    "/imagine
                    a futuristic city") to create unique images.</li>
                <li><strong>Multilingual Support</strong>: ChatBHO understands and responds in multiple languages,
                    including
                    English, Spanish, French, German, Italian, Portuguese, Dutch, Russian, Chinese (Simplified and
                    Traditional), Japanese, Korean, Arabic, Hindi, Bengali, and Turkish.</li>
                <li><strong>Text Assistance</strong>: Get help with writing, coding, spell-checking, summarizing text,
                    solving math problems, and more using the buttons or direct input.</li>
                <li><strong>Theme Switching</strong>: Switch between dark and light themes with "Switch theme to dark"
                    or
                    "Switch theme to light". Your preference is saved!</li>
                <li><strong>Persistent Chat</strong>: Messages and images are stored in your browser’s local storage, so
                    your chat history persists across refreshes until you delete it.</li>
            </ul>
            <h3>Usage Tips</h3>
            <ul>
                <li>Use the buttons in the chat area to quickly start common tasks, or type your questions directly.
                </li>
                <li>For math, try LaTeX-style input (e.g., "\((x^2 + 3)\)") for formatted equations.</li>
                <li>Images can be clicked to view full-size and downloaded via the modal.</li>
                <li>Clear your chat history using the trash icon in the header—don’t worry, it asks for confirmation!
                </li>
            </ul>
            <h3>Examples</h3>
            <ul>
                <li><strong>Image</strong>: "/imagine a serene mountain landscape at sunset"</li>
                <li><strong>Math</strong>: "Solve \(x^2 - 5x + 6 = 0\)"</li>
                <li><strong>Writing</strong>: "Help me write a letter to a friend"</li>
                <li><strong>Code</strong>: "Write a code of a simple calculator in Python"</li>
                <li><strong>Summary</strong>: "Summary of the last chapter of 'To Kill a Mockingbird'"</li>
            </ul>
            <p>Use the text input at the bottom to type your commands or questions. ChatBHO is here to help with almost
                anything—give it a try!</p>
            <p><b>N.B. - ChatGPT can make mistakes. <a href="about.html">Check important info.</a></b></p>
            <div class="modal-buttons">
                <button class="modal-button" onclick="closeInfoModal()">Got it!</button>
            </div>
        </div>
    </div>
    <!-- New Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="delete-modal-content">
            <span class="close-delete-btn" onclick="closeDeleteModal()"><i class="fa-solid fa-circle-xmark"></i></span>
            <h2>Are you sure?</h2>
            <p>You won't be able to revert this action!</p>
            <div class="modal-buttons">
                <button class="modal-button cancel" onclick="closeDeleteModal()">No, cancel!</button>
                <button class="modal-button" onclick="deleteMessages()">Yes, delete it!</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"></script>
    <script>
        // Button actions
        function buttonAction(action) {
            const inputArea = document.getElementById("inputField");
            if (action === 'Create image') { inputArea.value = '/imagine '; }
            if (action === 'Help me write') { inputArea.value = action; }
            if (action === 'Code') { inputArea.value = 'Write a code of '; }
            if (action === 'Meaning') { inputArea.value = 'Meaning of '; }
            if (action === 'Spell Check') { inputArea.value = 'Check the spelling of '; }
            if (action === 'Get advice') { inputArea.value = 'Give advice about '; }
            if (action === 'Summarize text') { inputArea.value = 'Summary of'; }
            if (action === 'Do Math') { inputArea.value = 'Solve A,B from equations A+B=3 and A-B =1 '; }
            if (action === 'Switch Theme') { inputArea.value = 'Switch theme to '; }
        }

        let currentImageUrl = ''; // Global variable for download

        function openModal(imageUrl) {
            const modal = document.getElementById("imageModal");
            const modalImage = document.getElementById("modalImage");
            modal.style.display = "flex";
            modalImage.src = imageUrl;
            currentImageUrl = imageUrl;
        }

        function closeModal() {
            document.getElementById("imageModal").style.display = "none";
        }

        function downloadImage() {
            const modalImage = document.getElementById("modalImage");
            const filename = modalImage.alt ? `${modalImage.alt.replace(/\s+/g, '_')}.png` : 'generated-image.png';
            fetch(currentImageUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error downloading image:', error);
                    alert('Failed to download the image. Please try again.');
                });
        }

        const inputField = document.getElementById('inputField');
        const messages = document.getElementById('messages');
        const sendButton = document.getElementById('sendButton');

        // Add Enter key listener
        inputField.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleUserMessage();
            }
        });

        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function (char) {
                switch (char) {
                    case '&': return '&amp;';
                    case '<': return '&lt;';
                    case '>': return '&gt;';
                    case '"': return '&quot;';
                    case "'": return '&#39;';
                    default: return char;
                }
            });
        }

        function parseMarkdown(text) {
            text = escapeHTML(text);
            text = text.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>');
            text = text.replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>');
            text = text.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
            text = text.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
            text = text.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
            text = text.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
            text = text.replace(/---/g, '<div class="separator"></div>');
            text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/_(.*?)_/g, '<em>$1</em>');
            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
            text = text.replace(/```([\s\S]+?)```/g, '<pre><code>$1</code></pre>');
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            text = text.replace(/(?:^|\n)[*-]\s?(.*)/g, function (match, p1) {
                return `<ul><li>${p1}</li></ul>`;
            });
            text = text.replace(/<\/ul>\s*<ul>/g, '');
            text = text.replace(/(?:^|\n)(\d+)\.\s?(.*)/g, function (match, p1, p2) {
                return `<ol><li>${p2}</li></ol>`;
            });
            text = text.replace(/<\/ol>\s*<ol>/g, '');
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\\\((.*?)\\\)/g, (match, expr) => {
                try {
                    const cleanedExpr = expr.replace(/[VN]/g, '').replace(/<br\s*\/?>/gi, '').trim();
                    return katex.renderToString(cleanedExpr, { throwOnError: false, displayMode: false, output: 'html' });
                } catch (error) {
                    return `<span class="math-error">${escapeHTML(expr)}</span>`;
                }
            });
            text = text.replace(/\\\[(.+?)\\\]/g, (match, expr) => {
                try {
                    const cleanedExpr = expr.replace(/[VN]/g, '').replace(/<br\s*\/?>/gi, '').trim();
                    return `<div class="katex-display">${katex.renderToString(cleanedExpr, { throwOnError: false, displayMode: true, output: 'html' })}</div>`;
                } catch (error) {
                    return `<div class="math-error">${escapeHTML(expr)}</div>`;
                }
            });
            text = text.replace(/\\\(|\\\)|\\\[|\\\]/g, '');
            return text;
        }

        // Load messages from localStorage on page load
        function loadMessages() {
            // Load theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else {
                document.documentElement.setAttribute('data-theme', 'dark'); // Default to dark if no theme saved
            }

            // Load messages
            const savedMessages = localStorage.getItem('chatMessages');
            if (savedMessages) {
                const chatData = JSON.parse(savedMessages);
                chatData.forEach(item => {
                    if (item.type === 'text') {
                        displayMessage(item.content, item.sender);
                    } else if (item.type === 'image') {
                        const image = document.createElement('img');
                        image.src = item.url;
                        image.alt = item.alt;
                        image.className = "generated-image";
                        image.onclick = function () { openModal(item.url); };
                        messages.appendChild(image);
                        messages.scrollTop = messages.scrollHeight;
                    }
                });
            } else {
                messages.innerHTML = `
                    <div class="help" id="helpText"></div>
                    <div class="main-container" id="mainContainer">
                        <button class="button" onclick="buttonAction('Create image')"><i class="fas fa-image"></i> Create image</button>
                        <button class="button" onclick="buttonAction('Help me write')"><i class="fas fa-pen"></i> Help me write</button>
                        <button class="button" onclick="buttonAction('Code')"><i class="fas fa-code"></i> Code</button>
                        <button class="button" onclick="buttonAction('Meaning')"><i class="fa-solid fa-language"></i> Meaning</button>
                        <button class="button" onclick="buttonAction('Spell Check')"><i class="fa-solid fa-spell-check"></i> Spell Check</button>
                        <button class="button" onclick="buttonAction('Get advice')"><i class="fas fa-graduation-cap"></i> Get advice</button>
                        <button class="button" onclick="buttonAction('Summarize text')"><i class="fas fa-file-alt"></i> Summarize text</button>
                        <button class="button" onclick="buttonAction('Do Math')"><i class="fas fa-calculator"></i> Do Math</button>
                        <button class="button" onclick="buttonAction('Switch Theme')"><i class="fa-solid fa-circle-half-stroke"></i>Switch Theme</button>
                    </div>
                `;
                index = 0;
                typeWriter();
            }
        }

        // Save to localStorage (for messages and images)
        function saveToLocalStorage(type, content, sender = null, url = null, alt = null) {
            const savedMessages = localStorage.getItem('chatMessages');
            const chatData = savedMessages ? JSON.parse(savedMessages) : [];
            if (type === 'text') {
                chatData.push({ type: 'text', content, sender });
            } else if (type === 'image') {
                chatData.push({ type: 'image', url, alt });
            }
            localStorage.setItem('chatMessages', JSON.stringify(chatData));
        }

        function handleUserMessage() {
            const userMessage = inputField.value.trim();
            if (userMessage === "") return;

            displayMessage(userMessage, 'user');
            saveToLocalStorage('text', userMessage, 'user'); // Save user message
            inputField.value = '';
            document.getElementById('helpText').style.display = "none";
            document.getElementById('mainContainer').style.display = "none";

            const lowerMessage = userMessage.toLowerCase();
            if (lowerMessage === "switch theme to dark") {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark'); // Save theme
                displayMessage("Switched to dark theme!", 'assistant');
                saveToLocalStorage('text', "Switched to dark theme!", 'assistant');
            } else if (lowerMessage === "switch theme to light") {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light'); // Save theme
                displayMessage("Switched to light theme!", 'assistant');
                saveToLocalStorage('text', "Switched to light theme!", 'assistant');
            } else {
                fetchAssistantResponse(userMessage);
            }
        }

        function displayMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = sender === 'user' ? 'user-message' : 'assistant-message';
            messageDiv.innerHTML = parseMarkdown(text);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
        }

        async function fetchAssistantResponse(userMessage) {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'assistant-message';
            typingDiv.innerHTML = '<span class="typing">Assistant is typing</span>';
            messages.appendChild(typingDiv);
            messages.scrollTop = messages.scrollHeight;

            if (userMessage.startsWith("/imagine")) {
                const prompt = userMessage.replace("/imagine", "").trim();
                if (prompt) {
                    try {
                        typingDiv.innerHTML = '<span class="typing">Please wait while generating your image</span>';
                        const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}/?nologo=1&width=1920&height=1920`;
                        const image = document.createElement('img');
                        image.src = imageUrl;
                        image.alt = prompt;
                        image.className = "generated-image";
                        image.onclick = function () { openModal(imageUrl); };
                        image.onload = function () {
                            typingDiv.innerHTML = '';
                            messages.appendChild(image);
                            saveToLocalStorage('image', null, null, imageUrl, prompt); // Save image
                            messages.scrollTop = messages.scrollHeight;
                        };
                        messages.appendChild(image);
                        messages.scrollTop = messages.scrollHeight;
                    } catch (error) {
                        typingDiv.innerHTML = "<span class='typing'>Error: Couldn't connect to the image server.</span>";
                        saveToLocalStorage('text', "Error: Couldn't connect to the image server.", 'assistant');
                    }
                } else {
                    typingDiv.innerHTML = "<span class='typing'>Please provide a prompt after /imagine.</span>";
                    saveToLocalStorage('text', "Please provide a prompt after /imagine.", 'assistant');
                }
            } else {
                const apiUrl = 'https://text.pollinations.ai/openai';
                const requestBody = {
                    model: 'openai-gpt-3',
                    messages: [{ role: 'user', content: userMessage }]
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        const assistantMessage = data.choices[0].message.content;
                        const formattedMessage = parseMarkdown(assistantMessage);
                        typingDiv.innerHTML = '';
                        const messageDiv = document.createElement('div');
                        messageDiv.className = 'assistant-message';
                        messageDiv.innerHTML = formattedMessage;
                        messages.appendChild(messageDiv);
                        saveToLocalStorage('text', assistantMessage, 'assistant'); // Save assistant response
                        messages.scrollTop = messages.scrollHeight;
                    } else {
                        typingDiv.innerHTML = "<span class='typing'>Sorry, I couldn't process your request.</span>";
                        saveToLocalStorage('text', "Sorry, I couldn't process your request.", 'assistant');
                    }
                } catch (error) {
                    typingDiv.innerHTML = "<span class='typing'>Error: Couldn't connect to the server.</span>";
                    saveToLocalStorage('text', "Error: Couldn't connect to the server.", 'assistant');
                }
            }
        }

        const text = "What can I help with?";
        const speed = 50;
        let index = 0;

        function typeWriter() {
            if (index < text.length) {
                document.getElementById("helpText").innerHTML += text.charAt(index);
                index++;
                setTimeout(typeWriter, speed);
            }
        }

        // Updated showInfo with modal
        function showInfo() {
            document.getElementById("infoModal").style.display = "flex";
        }

        function closeInfoModal() {
            document.getElementById("infoModal").style.display = "none";
        }


        // Updated confirmDeletion with modal
        function confirmDeletion() {
            document.getElementById("deleteModal").style.display = "flex";
        }

        function closeDeleteModal() {
            document.getElementById("deleteModal").style.display = "none";
            // Show cancellation message in a temporary div (mimicking Swal)
            const tempMessage = document.createElement('div');
            tempMessage.className = 'assistant-message';
            tempMessage.innerHTML = parseMarkdown("Cancelled: Your messages are safe.");
            messages.appendChild(tempMessage);
            messages.scrollTop = messages.scrollHeight;
            setTimeout(() => tempMessage.remove(), 2000); // Remove after 2 seconds
        }

        function deleteMessages() {
            messages.innerHTML = '';
            localStorage.removeItem('chatMessages');
            localStorage.removeItem('theme');
            document.documentElement.setAttribute('data-theme', 'dark');
            messages.innerHTML = `
                <div class="help" id="helpText"></div>
                <div class="main-container" id="mainContainer">
                    <button class="button" onclick="buttonAction('Create image')"><i class="fas fa-image"></i> Create image</button>
                    <button class="button" onclick="buttonAction('Help me write')"><i class="fas fa-pen"></i> Help me write</button>
                    <button class="button" onclick="buttonAction('Code')"><i class="fas fa-code"></i> Code</button>
                    <button class="button" onclick="buttonAction('Meaning')"><i class="fa-solid fa-language"></i> Meaning</button>
                    <button class="button" onclick="buttonAction('Spell Check')"><i class="fa-solid fa-spell-check"></i> Spell Check</button>
                    <button class="button" onclick="buttonAction('Get advice')"><i class="fas fa-graduation-cap"></i> Get advice</button>
                    <button class="button" onclick="buttonAction('Summarize text')"><i class="fas fa-file-alt"></i> Summarize text</button>
                    <button class="button" onclick="buttonAction('Do Math')"><i class="fas fa-calculator"></i> Do Math</button>
                    <button class="button" onclick="buttonAction('Switch Theme')"><i class="fa-solid fa-circle-half-stroke"></i>Switch Theme</button>
                </div>
            `;
            index = 0;
            typeWriter();
            document.getElementById("deleteModal").style.display = "none";
        }
        function fadeInMainContainer() {
            const mainContainer = document.getElementById('mainContainer');
            mainContainer.style.display = 'flex';
            mainContainer.style.animationName = 'fadeIn';
        }

        // Load messages on page load
        window.onload = function () {
            loadMessages();
        };
    </script>
</body>

</html>