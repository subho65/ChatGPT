<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css">
    <link rel="icon" type="image/png" href="android-chrome-512x512.png" id="favicon">
    <title>ChatBHO</title>
    <style>
        :root,
        [data-theme="dark"] {
            --bg-primary: #141c2f;
            --bg-secondary: #1e2a44;
            --accent: #00b7ff;
            --text-primary: #d9e1e8;
            --text-secondary: #8a94a6;
            --user-bubble: #0066cc;
            --assistant-bubble: #2a3555;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            --radius: 0.8rem;
            --input-border: #3a4666;
            --code-bg: #1a233b;
            --separator: #2e3b5a;
            --error-color: #ff6b6b;
        }

        [data-theme="light"] {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --accent: #007bff;
            --text-primary: #1a2a44;
            --text-secondary: #6b7280;
            --user-bubble: #007bff;
            --assistant-bubble: #e5e7eb;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --radius: 0.8rem;
            --input-border: #d1d5db;
            --code-bg: #f3f4f6;
            --separator: #d1d5db;
            --error-color: #e53e3e;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: "Arial", sans-serif;
            overflow-y: auto;
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            width: 90%;
            max-width: 900px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            font-size: clamp(1.5rem, 4vw, 2rem);
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text-primary);
            font-weight: 600;
            position: relative;
            border-bottom: 1px solid var(--separator);
        }

        .menu-button,
        .new-chat-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .menu-button:hover,
        .new-chat-button:hover {
            color: var(--accent);

        }

        .menu-button {
            position: absolute;
            top: 50%;
            left: 1rem;
            transform: translateY(-50%);
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
            position: absolute;
            right: 1rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .chat-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent) var(--bg-secondary);
        }

        .chat-area::-webkit-scrollbar {
            width: 6px;
        }

        .chat-area::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 3px;
        }

        .chat-area::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .user-message,
        .assistant-message {
            max-width: fit-content;
            min-width: 10%;
            font-size: clamp(0.9rem, 2vw, 1rem);
            line-height: 1.5;
            padding: 0.8rem 1.3rem;
            margin: 0.6rem 0;
            border-radius: var(--radius);
            word-wrap: break-word;
            box-shadow: var(--shadow);
        }

        .user-message {
            background: var(--user-bubble);
            color: #fff;
            margin-left: auto;
        }

        .assistant-message {
            background: var(--assistant-bubble);
            color: var(--text-primary);
            margin-right: auto;
        }

        .assistant-message .typing {
            color: var(--text-secondary);
            font-style: italic;
            font-size: 0.9em;
            background: none;
            padding: 0;
            margin: 0;
        }

        .assistant-message:empty {
            display: none;
        }

        .katex {
            display: inline-block;
            vertical-align: middle;
            margin: 0 0.2rem;
            padding: 0;
        }

        .katex-display {
            display: block;
            margin: 0.5rem 0;
            text-align: center;
            padding: 0;
            line-height: 1.2;
        }

        .katex-display>.katex {
            display: inline-block;
        }

        .katex-html {
            line-height: 1.2;
            white-space: normal;
        }

        .math-error {
            color: var(--error-color);
            font-style: italic;
        }

        .input-container {
            width: 100%;
            background: var(--bg-primary);
            padding: 0.8rem 1rem;
            border-top: 1px solid var(--separator);
            display: flex;
            align-items: center;
            z-index: 10;
        }

        input {
            flex: 1;
            background: var(--bg-secondary);
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            color: var(--text-primary);
            font-size: clamp(0.9rem, 2vw, 1rem);
            padding: 0.6rem 1rem;
            outline: none;
            transition: border-color 0.3s ease, background 0.3s ease;
        }

        input:focus {
            border-color: var(--accent);
            background: [data-theme="dark"] ? #253054: #f0f4f8;
        }

        #sendButton {
            background: var(--accent);
            border: none;
            color: #fff;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 0.8rem;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease-in-out;
        }

        #sendButton:hover {
            background: [data-theme="dark"] ? #0099d6: #0056b3;
            transform: scale(1.1);
        }

        #sendButton:active {
            transform: scale(1);
        }

        pre {
            background: var(--code-bg);
            color: [data-theme="dark"] ? #dcdcdc: #1a2a44;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: clamp(0.85rem, 2vw, 0.95rem);
        }

        code {
            color: [data-theme="dark"] ? #dcdcdc: #1a2a44;
        }

        .separator {
            border-top: 1px solid var(--separator);
            margin: 1rem 0;
        }

        .typing::after {
            content: '.';
            animation: dots 1s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60% {
                content: '...';
            }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.9);
        }

        [data-theme="light"] .modal {
            background: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 800px;
            box-shadow: var(--shadow);
            position: relative;
        }

        .modal img {
            width: 100%;
            border-radius: 0.5rem;
            max-height: 80vh;
        }

        .close-btn,
        .download-btn {
            position: absolute;
            top: 1rem;
            color: var(--text-primary);
            font-size: clamp(1.2rem, 3vw, 1.5rem);
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;
            background: none;
            border: none;
        }

        .close-btn:hover,
        .download-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        .close-btn {
            right: 1rem;
            font-size: clamp(1.5rem, 4vw, 2rem);
        }

        .download-btn {
            right: 3rem;
        }

        .main-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            padding: 1rem;
            margin-top: 1vh;
            opacity: 0;
            animation: fadeIn 2s forwards;
        }

        .help {
            font-size: clamp(2rem, 4vw, 2rem);
            text-align: center;
            color: var(--text-primary);
            margin: 15vh 0 2rem;
            font-weight: 600;
        }

        .button {
            background: var(--assistant-bubble);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            border-radius: 2rem;
            padding: clamp(0.6rem, 2vw, 0.8rem) clamp(1rem, 3vw, 1.2rem);
            font-size: clamp(0.85rem, 2vw, 1rem);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .button i {
            font-size: clamp(1rem, 2.5vw, 1.2rem);
        }

        .button:nth-child(1) i {
            color: #00cc66;
        }

        .button:nth-child(2) i {
            color: #ff3366;
        }

        .button:nth-child(3) i {
            color: #3366ff;
        }

        .button:nth-child(4) i {
            color: #00cccc;
        }

        .button:nth-child(5) i {
            color: #ff9900;
        }

        .button:nth-child(6) i {
            color: #ccff33;
        }

        .button:nth-child(7) i {
            color: #33cccc;
        }

        .button:nth-child(8) i {
            color: #ff6633;
        }

        .button:nth-child(9) i {
            color: #ff0000;
        }

        .button:hover {
            background: [data-theme="dark"] ? #344066: #d1d5db;
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            .container {
                width: 100%;
                height: 100vh;
            }

            .chat-area {
                padding: 1rem;
                padding-bottom: 70px;
            }

            .input-container {
                position: fixed;
                bottom: 0;
                left: 0;
                padding: 0.6rem;
            }

            img.generated-image {
                width: 80%;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1000px;
            }
        }

        img.generated-image {
            width: 50%;
            border-radius: 10px;
            margin-top: 15px;
        }

        #infoModal,
        #deleteModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        [data-theme="dark"] #infoModal,
        [data-theme="dark"] #deleteModal {
            background: rgba(0, 0, 0, 0.9);
        }

        [data-theme="light"] #infoModal,
        [data-theme="light"] #deleteModal {
            background: rgba(0, 0, 0, 0.7);
        }

        .info-modal-content,
        .delete-modal-content {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            position: relative;
            color: var(--text-primary);
            max-height: 80vh;
            overflow-y: auto;
        }

        @media (min-width: 768px) {

            .info-modal-content,
            .delete-modal-content {
                width: 70%;
                max-width: 800px;
            }
        }

        .info-modal-content h2,
        .delete-modal-content h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .info-modal-content h3 {
            font-size: 1.2rem;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .info-modal-content p,
        .delete-modal-content p {
            font-size: 1rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .info-modal-content ul {
            font-size: 0.9rem;
            line-height: 1.4;
            padding-left: 20px;
            text-align: justify;
            margin-bottom: 1rem;
        }

        .info-modal-content ul li {
            margin-bottom: 0.5rem;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        .modal-button {
            background: var(--accent);
            color: #fff;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .modal-button:hover {
            background: #0099d6;
        }

        .modal-button.cancel {
            background: var(--error-color);
        }

        .modal-button.cancel:hover {
            background: #e53e3e;
        }

        .close-info-btn,
        .close-delete-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: var(--text-primary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s ease, transform 0.2s ease;

        }

        .close-info-btn:hover,
        .close-delete-btn:hover {
            color: var(--accent);
            transform: scale(1.1);
        }

        .header-logo {
            width: auto;
            height: 40px;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        [data-theme="dark"] .header-logo {
            content: url("dark.png");
        }

        [data-theme="light"] .header-logo {
            content: url("light.png");
        }

        .menu-panel {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100%;
            background: var(--bg-secondary);
            box-shadow: var(--shadow);
            z-index: 1000;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .history-item {
            padding: 0.8rem;
            margin: 0.5rem 0;
            background: var(--assistant-bubble);
            border-radius: var(--radius);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: var(--accent);
            color: #fff;
        }

        .history-item .delete-chat {
            color: var(--error-color);
            cursor: pointer;
        }

        .history-item .delete-chat:hover {
            transform: scale(1.1);
        }

        .menu-footer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1rem;
            border-top: 1px solid var(--separator);
            background: var(--bg-secondary);
            /* Ensures it blends with the panel */
        }

        .info-menu-button {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.5rem;
            width: 100%;
            text-align: left;
            transition: color 0.3s ease;
        }

        .info-menu-button:hover {
            color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <button class="menu-button" id="menuButton"><i class="fas fa-bars"></i></button>
            <img src="dark.png" alt="ChatBHO Logo" class="header-logo">
            ChatBHO
            <div class="header-buttons">
                <button class="new-chat-button" id="newChatButton"><i class="fas fa-plus"></i></button>
            </div>
        </div>
        <div class="chat-area" id="messages">
            <div class="help" id="helpText"></div>
            <div class="main-container" id="mainContainer">
                <button class="button" id="createImageBtn"><i class="fas fa-image"></i> Create image</button>
                <button class="button" id="helpWriteBtn"><i class="fas fa-pen"></i> Help me write</button>
                <button class="button" id="codeBtn"><i class="fas fa-code"></i> Code</button>
                <button class="button" id="meaningBtn"><i class="fa-solid fa-language"></i> Meaning</button>
                <button class="button" id="spellCheckBtn"><i class="fa-solid fa-spell-check"></i> Spell Check</button>
                <button class="button" id="adviceBtn"><i class="fas fa-graduation-cap"></i> Get advice</button>
                <button class="button" id="summarizeBtn"><i class="fas fa-file-alt"></i> Summarize text</button>
                <button class="button" id="mathBtn"><i class="fas fa-calculator"></i> Do Math</button>
                <button class="button" id="themeBtn"><i class="fa-solid fa-circle-half-stroke"></i>Switch Theme</button>
            </div>
        </div>
        <div class="input-container">
            <input type="text" id="inputField" placeholder="Message ChatBHO">
            <button id="sendButton"><i class="fas fa-arrow-up"></i></button>
        </div>
    </div>

    <div class="menu-panel" id="menuPanel">
        <div class="menu-header">
            <h3>Chat History</h3>
            <button class="close-btn" id="closeMenuBtn"><i class="fa-solid fa-circle-xmark"></i></button>
        </div>
        <div id="historyList"></div>
        <div class="menu-footer">
            <button class="info-menu-button" id="menuInfoButton"><i class="fas fa-info-circle"></i> Info</button>
        </div>
    </div>

    <div id="imageModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeImageModal"><i class="fa-solid fa-circle-xmark"></i></span>
            <span id="downloadLink" class="download-btn"><i class="fas fa-download"></i></span>
            <img id="modalImage" alt="Generated image">
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="info-modal-content">
            <span class="close-info-btn" id="closeInfoModalBtn"><i class="fa-solid fa-circle-xmark"></i></span>
            <h2>Welcome to ChatBHO!</h2>
            <p>ChatBHO is your versatile virtual assistant designed to assist with a wide range of tasks. Here’s how to
                get started and make the most of its capabilities:</p>
            <h3>Key Features</h3>
            <ul>
                <li><strong>Image Generation</strong>: Use <code>/imagine</code> followed by a description (e.g.,
                    "/imagine a futuristic city") to create unique images.</li>
                <li><strong>Multilingual Support</strong>: ChatBHO understands and responds in multiple languages,
                    including English, Spanish, French, German, Italian, Portuguese, Dutch, Russian, Chinese (Simplified
                    and Traditional), Japanese, Korean, Arabic, Hindi, Bengali, and Turkish.</li>
                <li><strong>Text Assistance</strong>: Get help with writing, coding, spell-checking, summarizing text,
                    solving math problems, and more using the buttons or direct input.</li>
                <li><strong>Theme Switching</strong>: Switch between dark and light themes with "Switch theme to dark"
                    or "Switch theme to light". Your preference is saved!</li>
                <li><strong>Persistent Chat</strong>: Messages and images are stored in your browser’s local storage, so
                    your chat history persists across refreshes until you delete it.</li>
            </ul>
            <h3>Usage Tips</h3>
            <ul>
                <li>Use the buttons in the chat area to quickly start common tasks, or type your questions directly.
                </li>
                <li>For math, try LaTeX-style input (e.g., "\((x^2 + 3)\)") for formatted equations.</li>
                <li>Images can be clicked to view full-size and downloaded via the modal.</li>
                <li>Clear your chat history using the trash icon in the header—don’t worry, it asks for confirmation!
                </li>
            </ul>
            <h3>Examples</h3>
            <ul>
                <li><strong>Image</strong>: "/imagine a serene mountain landscape at sunset"</li>
                <li><strong>Math</strong>: "Solve \(x^2 - 5x + 6 = 0\)"</li>
                <li><strong>Writing</strong>: "Help me write a letter to a friend"</li>
                <li><strong>Code</strong>: "Write a code of a simple calculator in Python"</li>
                <li><strong>Summary</strong>: "Summary of the last chapter of 'To Kill a Mockingbird'"</li>
            </ul>
            <p>Use the text input at the bottom to type your commands or questions. ChatBHO is here to help with almost
                anything—give it a try!</p>
            <p><b>N.B. - ChatGPT can make mistakes. <a href="about.html">Check important info.</a></b></p>
            <div class="modal-buttons">
                <button class="modal-button" id="infoGotItBtn">Got it!</button>
            </div>
        </div>
    </div>

    <div id="deleteChatModal" class="modal">
        <div class="delete-modal-content">
            <span class="close-delete-btn" id="closeDeleteChatModalBtn"><i class="fa-solid fa-circle-xmark"></i></span>
            <h2>Delete Chat?</h2>
            <p>Are you sure you want to delete this chat? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button class="modal-button cancel" id="cancelDeleteChatBtn">Cancel</button>
                <button class="modal-button" id="confirmDeleteChatBtn">Delete</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            let currentChatId = null;
            let chats = JSON.parse(localStorage.getItem('chats')) || {};
            let chatIdToDelete = null;
            const menuPanel = document.getElementById('menuPanel');
            if (menuPanel) menuPanel.style.display = 'none';
            const deleteChatModal = document.getElementById('deleteChatModal');
            const closeDeleteChatModalBtn = document.getElementById('closeDeleteChatModalBtn');
            const cancelDeleteChatBtn = document.getElementById('cancelDeleteChatBtn');
            const confirmDeleteChatBtn = document.getElementById('confirmDeleteChatBtn');
            const inputField = document.getElementById('inputField');
            const messages = document.getElementById('messages');
            const sendButton = document.getElementById('sendButton');
            const menuButton = document.getElementById('menuButton');
            const newChatButton = document.getElementById('newChatButton');
            const closeMenuBtn = document.getElementById('closeMenuBtn');
            const menuInfoButton = document.getElementById('menuInfoButton');
            const closeImageModal = document.getElementById('closeImageModal');
            const downloadLink = document.getElementById('downloadLink');
            const closeInfoModalBtn = document.getElementById('closeInfoModalBtn');
            const infoGotItBtn = document.getElementById('infoGotItBtn');
            const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

            // Main container buttons
            const createImageBtn = document.getElementById('createImageBtn');
            const helpWriteBtn = document.getElementById('helpWriteBtn');
            const codeBtn = document.getElementById('codeBtn');
            const meaningBtn = document.getElementById('meaningBtn');
            const spellCheckBtn = document.getElementById('spellCheckBtn');
            const adviceBtn = document.getElementById('adviceBtn');
            const summarizeBtn = document.getElementById('summarizeBtn');
            const mathBtn = document.getElementById('mathBtn');
            const themeBtn = document.getElementById('themeBtn');

            function buttonAction(action) {
                if (inputField) {
                    if (action === 'Create image') inputField.value = '/imagine ';
                    if (action === 'Help me write') inputField.value = action;
                    if (action === 'Code') inputField.value = 'Write a code of ';
                    if (action === 'Meaning') inputField.value = 'Meaning of ';
                    if (action === 'Spell Check') inputField.value = 'Check the spelling of ';
                    if (action === 'Get advice') inputField.value = 'Give advice about ';
                    if (action === 'Summarize text') inputField.value = 'Summary of';
                    if (action === 'Do Math') inputField.value = 'Solve A,B from equations A+B=3 and A-B =1 ';
                    if (action === 'Switch Theme') inputField.value = 'Switch theme to ';
                }
            }

            function openModal(imageUrl) {
                const modal = document.getElementById("imageModal");
                const modalImage = document.getElementById("modalImage");
                if (modal && modalImage) {
                    modal.style.display = "flex";
                    modalImage.src = imageUrl;
                }
            }

            function closeModal() {
                const modal = document.getElementById("imageModal");
                if (modal) modal.style.display = "none";
            }

            function downloadImage() {
                const modalImage = document.getElementById("modalImage");
                if (modalImage) {
                    const filename = modalImage.alt ? `${modalImage.alt.replace(/\s+/g, '_')}.png` : 'generated-image.png';
                    fetch(modalImage.src)
                        .then(response => response.blob())
                        .then(blob => {
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.style.display = 'none';
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            document.body.removeChild(a);
                        })
                        .catch(error => console.error('Error downloading image:', error));
                }
            }

            function escapeHTML(str) {
                return str.replace(/[&<>"']/g, function (char) {
                    switch (char) {
                        case '&': return '&';
                        case '<': return '<';
                        case '>': return '>';
                        case '"': return '"';
                        case "'": return "'";
                        default: return char;
                    }
                });
            }

            function parseMarkdown(text) {
                text = escapeHTML(text);
                text = text.replace(/^######\s+(.*)$/gm, '<h6>$1</h6>');
                text = text.replace(/^#####\s+(.*)$/gm, '<h5>$1</h5>');
                text = text.replace(/^####\s+(.*)$/gm, '<h4>$1</h4>');
                text = text.replace(/^###\s+(.*)$/gm, '<h3>$1</h3>');
                text = text.replace(/^##\s+(.*)$/gm, '<h2>$1</h2>');
                text = text.replace(/^#\s+(.*)$/gm, '<h1>$1</h1>');
                text = text.replace(/---/g, '<div class="separator"></div>');
                text = text.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
                text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                text = text.replace(/_(.*?)_/g, '<em>$1</em>');
                text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
                text = text.replace(/```([\s\S]+?)```/g, '<pre><code>$1</code></pre>');
                text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
                text = text.replace(/(?:^|\n)[*-]\s?(.*)/g, function (match, p1) {
                    return `<ul><li>${p1}</li></ul>`;
                });
                text = text.replace(/<\/ul>\s*<ul>/g, '');
                text = text.replace(/(?:^|\n)(\d+)\.\s?(.*)/g, function (match, p1, p2) {
                    return `<ol><li>${p2}</li></ol>`;
                });
                text = text.replace(/<\/ol>\s*<ol>/g, '');
                text = text.replace(/\n/g, '<br>');
                text = text.replace(/\\\((.*?)\\\)/g, (match, expr) => {
                    try {
                        const cleanedExpr = expr.replace(/[VN]/g, '').replace(/<br\s*\/?>/gi, '').trim();
                        return katex.renderToString(cleanedExpr, { throwOnError: false, displayMode: false, output: 'html' });
                    } catch (error) {
                        return `<span class="math-error">${escapeHTML(expr)}</span>`;
                    }
                });
                text = text.replace(/\\\[(.+?)\\\]/g, (match, expr) => {
                    try {
                        const cleanedExpr = expr.replace(/[VN]/g, '').replace(/<br\s*\/?>/gi, '').trim();
                        return `<div class="katex-display">${katex.renderToString(cleanedExpr, { throwOnError: false, displayMode: true, output: 'html' })}</div>`;
                    } catch (error) {
                        return `<div class="math-error">${escapeHTML(expr)}</div>`;
                    }
                });
                text = text.replace(/\\\(|\\\)|\\\[|\\\]/g, '');
                return text;
            }

            function loadMessages() {
                const savedTheme = localStorage.getItem('theme');

                if (savedTheme) {
                    document.documentElement.setAttribute('data-theme', savedTheme);
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }

                updateHistoryList();
                showMainPage();
            }

            function showMainPage() {
                if (messages) {
                    messages.innerHTML = `
                        <div class="help" id="helpText"></div>
                        <div class="main-container" id="mainContainer">
                            <button class="button" id="createImageBtn"><i class="fas fa-image"></i> Create image</button>
                            <button class="button" id="helpWriteBtn"><i class="fas fa-pen"></i> Help me write</button>
                            <button class="button" id="codeBtn"><i class="fas fa-code"></i> Code</button>
                            <button class="button" id="meaningBtn"><i class="fa-solid fa-language"></i> Meaning</button>
                            <button class="button" id="spellCheckBtn"><i class="fa-solid fa-spell-check"></i> Spell Check</button>
                            <button class="button" id="adviceBtn"><i class="fas fa-graduation-cap"></i> Get advice</button>
                            <button class="button" id="summarizeBtn"><i class="fas fa-file-alt"></i> Summarize text</button>
                            <button class="button" id="mathBtn"><i class="fas fa-calculator"></i> Do Math</button>
                            <button class="button" id="themeBtn"><i class="fa-solid fa-circle-half-stroke"></i>Switch Theme</button>
                        </div>
                    `;
                    index = 0;
                    typeWriter();
                    addMainContainerListeners();
                }
                currentChatId = null;
            }

            function saveToLocalStorage(type, content, sender = null, url = null, alt = null) {
                if (!currentChatId) return;
                if (!chats[currentChatId]) {
                    chats[currentChatId] = { messages: [], title: `Chat ${Object.keys(chats).length}` };
                }
                const chat = chats[currentChatId];
                if (type === 'text') {
                    chat.messages.push({ type: 'text', content, sender });
                    if (sender === 'user' && chat.messages.length === 1) {
                        chat.title = content.substring(0, 30) + (content.length > 30 ? '...' : '');
                    }
                } else if (type === 'image') {
                    chat.messages.push({ type: 'image', url, alt });
                }
                localStorage.setItem('chats', JSON.stringify(chats));
                updateHistoryList();
            }

            function handleUserMessage() {
                if (!inputField || !messages) return;
                const userMessage = inputField.value.trim();
                if (userMessage === "") return;

                if (!currentChatId) {
                    currentChatId = createNewChat();
                }

                displayMessage(userMessage, 'user');
                saveToLocalStorage('text', userMessage, 'user');
                inputField.value = '';
                const helpText = document.getElementById('helpText');
                const mainContainer = document.getElementById('mainContainer');
                if (helpText) helpText.style.display = "none";
                if (mainContainer) mainContainer.style.display = "none";

                const lowerMessage = userMessage.toLowerCase();
                if (lowerMessage === "switch theme to dark") {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    displayMessage("Switched to dark theme!", 'assistant');
                    saveToLocalStorage('text', "Switched to dark theme!", 'assistant');
                } else if (lowerMessage === "switch theme to light") {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                    displayMessage("Switched to light theme!", 'assistant');
                    saveToLocalStorage('text', "Switched to light theme!", 'assistant');
                } else {
                    fetchAssistantResponse(userMessage);
                }
            }

            function displayMessage(text, sender) {
                if (!messages) return;
                const messageDiv = document.createElement('div');
                messageDiv.className = sender === 'user' ? 'user-message' : 'assistant-message';
                messageDiv.innerHTML = parseMarkdown(text);
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
            }

            async function fetchAssistantResponse(userMessage) {
                if (!messages) return;
                const typingDiv = document.createElement('div');
                typingDiv.className = 'assistant-message';
                typingDiv.innerHTML = '<span class="typing">Assistant is typing</span>';
                messages.appendChild(typingDiv);
                messages.scrollTop = messages.scrollHeight;

                if (userMessage.startsWith("/imagine")) {
                    const prompt = userMessage.replace("/imagine", "").trim();
                    if (prompt) {
                        try {
                            typingDiv.innerHTML = '<span class="typing">Please wait while generating your image</span>';
                            const imageUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}/?nologo=1&width=1920&height=1920`;
                            const image = document.createElement('img');
                            image.src = imageUrl;
                            image.alt = prompt;
                            image.className = "generated-image";
                            image.onclick = function () { openModal(imageUrl); };
                            image.onload = function () {
                                typingDiv.remove();
                                messages.appendChild(image);
                                saveToLocalStorage('image', null, null, imageUrl, prompt);
                                messages.scrollTop = messages.scrollHeight;
                            };
                        } catch (error) {
                            typingDiv.innerHTML = "<span class='typing'>Error: Couldn't connect to the image server.</span>";
                            saveToLocalStorage('text', "Error: Couldn't connect to the image server.", 'assistant');
                        }
                    } else {
                        typingDiv.innerHTML = "<span class='typing'>Please provide a prompt after /imagine.</span>";
                        saveToLocalStorage('text', "Please provide a prompt after /imagine.", 'assistant');
                    }
                } else {
                    const apiUrl = 'https://text.pollinations.ai/openai';
                    const requestBody = {
                        model: 'openai-gpt-3',
                        messages: [{ role: 'user', content: userMessage }]
                    };
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });
                        if (response.ok) {
                            const data = await response.json();
                            const assistantMessage = data.choices[0].message.content;
                            typingDiv.remove();
                            displayMessage(assistantMessage, 'assistant');
                            saveToLocalStorage('text', assistantMessage, 'assistant');
                        } else {
                            typingDiv.innerHTML = "<span class='typing'>Sorry, I couldn't process your request.</span>";
                            saveToLocalStorage('text', "Sorry, I couldn't process your request.", 'assistant');
                        }
                    } catch (error) {
                        typingDiv.innerHTML = "<span class='typing'>Error: Couldn't connect to the server.</span>";
                        saveToLocalStorage('text', "Error: Couldn't connect to the server.", 'assistant');
                    }
                }
            }

            const text = "What can I help with?";
            const speed = 50;
            let index = 0;

            function typeWriter() {
                const helpText = document.getElementById("helpText");
                if (helpText && index < text.length) {
                    helpText.innerHTML += text.charAt(index);
                    index++;
                    setTimeout(typeWriter, speed);
                }
            }

            function showInfo() {
                const infoModal = document.getElementById("infoModal");
                if (infoModal) infoModal.style.display = "flex";
            }

            function closeInfoModal() {
                const infoModal = document.getElementById("infoModal");
                if (infoModal) infoModal.style.display = "none";
            }

            function confirmDeletion() {
                const deleteModal = document.getElementById("deleteModal");
                if (deleteModal) deleteModal.style.display = "flex";
            }

            function closeDeleteModal() {
                const deleteModal = document.getElementById("deleteModal");
                if (deleteModal) deleteModal.style.display = "none";
                if (messages) {
                    const tempMessage = document.createElement('div');
                    tempMessage.className = 'assistant-message';
                    tempMessage.innerHTML = parseMarkdown("Cancelled: Your messages are safe.");
                    messages.appendChild(tempMessage);
                    messages.scrollTop = messages.scrollHeight;
                    setTimeout(() => tempMessage.remove(), 2000);
                }
            }

            function deleteMessages() {
                if (currentChatId && chats[currentChatId]) {
                    delete chats[currentChatId];
                    localStorage.setItem('chats', JSON.stringify(chats));
                    updateHistoryList();
                    showMainPage();
                }
                const deleteModal = document.getElementById("deleteModal");
                if (deleteModal) deleteModal.style.display = "none";
            }

            function createNewChat() {
                const chatId = `chat_${Date.now()}`;
                chats[chatId] = {
                    messages: [],
                    title: `Chat ${Object.keys(chats).length + 1}`
                };
                currentChatId = chatId;
                localStorage.setItem('chats', JSON.stringify(chats));
                updateHistoryList();
                showMainPage();
                return chatId;
            }

            function loadChat(chatId) {
                currentChatId = chatId;
                if (messages && chats[chatId]) {
                    messages.innerHTML = '';
                    const chat = chats[chatId];
                    chat.messages.forEach(item => {
                        if (item.type === 'text') {
                            displayMessage(item.content, item.sender);
                        } else if (item.type === 'image') {
                            const image = document.createElement('img');
                            image.src = item.url;
                            image.alt = item.alt;
                            image.className = "generated-image";
                            image.onclick = function () { openModal(item.url); };
                            messages.appendChild(image);
                        }
                    });
                    messages.scrollTop = messages.scrollHeight;
                }
                toggleMenu();
            }

            function toggleMenu() {
                const menuPanel = document.getElementById('menuPanel');
                if (menuPanel) {
                    menuPanel.style.display = menuPanel.style.display === 'block' ? 'none' : 'block';
                }
            }

            function updateHistoryList() {
                const historyList = document.getElementById('historyList');
                if (historyList) {
                    historyList.innerHTML = '';
                    Object.entries(chats).forEach(([chatId, chat]) => {
                        const div = document.createElement('div');
                        div.className = 'history-item';

                        const titleSpan = document.createElement('span');
                        titleSpan.textContent = chat.title;
                        titleSpan.className = 'history-title';

                        const deleteSpan = document.createElement('span');
                        deleteSpan.className = 'delete-chat';
                        deleteSpan.innerHTML = '<i class="fas fa-trash"></i>';

                        div.appendChild(titleSpan);
                        div.appendChild(deleteSpan);

                        div.addEventListener('click', (event) => {
                            if (event.target !== deleteSpan && !deleteSpan.contains(event.target)) {
                                loadChat(chatId);
                            }
                        });
                        deleteSpan.addEventListener('click', (event) => {
                            event.stopPropagation();
                            chatIdToDelete = chatId; // Store the chat ID to delete
                            if (deleteChatModal) deleteChatModal.style.display = 'flex'; // Show the modal
                        });

                        historyList.appendChild(div);
                    });
                }
            }
            function deleteChat(chatId) {
                if (chats[chatId]) {
                    delete chats[chatId];
                    localStorage.setItem('chats', JSON.stringify(chats));
                    updateHistoryList();
                    if (currentChatId === chatId) {
                        showMainPage();
                    }
                }
            }

            function addMainContainerListeners() {
                const createImageBtn = document.getElementById('createImageBtn');
                const helpWriteBtn = document.getElementById('helpWriteBtn');
                const codeBtn = document.getElementById('codeBtn');
                const meaningBtn = document.getElementById('meaningBtn');
                const spellCheckBtn = document.getElementById('spellCheckBtn');
                const adviceBtn = document.getElementById('adviceBtn');
                const summarizeBtn = document.getElementById('summarizeBtn');
                const mathBtn = document.getElementById('mathBtn');
                const themeBtn = document.getElementById('themeBtn');

                if (createImageBtn) createImageBtn.addEventListener('click', () => buttonAction('Create image'));
                if (helpWriteBtn) helpWriteBtn.addEventListener('click', () => buttonAction('Help me write'));
                if (codeBtn) codeBtn.addEventListener('click', () => buttonAction('Code'));
                if (meaningBtn) meaningBtn.addEventListener('click', () => buttonAction('Meaning'));
                if (spellCheckBtn) spellCheckBtn.addEventListener('click', () => buttonAction('Spell Check'));
                if (adviceBtn) adviceBtn.addEventListener('click', () => buttonAction('Get advice'));
                if (summarizeBtn) summarizeBtn.addEventListener('click', () => buttonAction('Summarize text'));
                if (mathBtn) mathBtn.addEventListener('click', () => buttonAction('Do Math'));
                if (themeBtn) themeBtn.addEventListener('click', () => buttonAction('Switch Theme'));
            }

            // Add event listeners
            if (sendButton) sendButton.addEventListener('click', handleUserMessage);
            if (inputField) inputField.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    handleUserMessage();
                }
            });
            if (menuButton) menuButton.addEventListener('click', toggleMenu);
            if (newChatButton) newChatButton.addEventListener('click', createNewChat);
            if (closeMenuBtn) closeMenuBtn.addEventListener('click', toggleMenu);
            if (menuInfoButton) menuInfoButton.addEventListener('click', () => { showInfo(); toggleMenu(); });
            if (closeImageModal) closeImageModal.addEventListener('click', closeModal);
            if (downloadLink) downloadLink.addEventListener('click', downloadImage);
            if (closeInfoModalBtn) closeInfoModalBtn.addEventListener('click', closeInfoModal);
            if (infoGotItBtn) infoGotItBtn.addEventListener('click', closeInfoModal);
            if (closeDeleteModalBtn) closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', deleteMessages);

            // Initial load
            loadMessages();
             if (closeDeleteChatModalBtn) {
                closeDeleteChatModalBtn.addEventListener('click', () => {
                    if (deleteChatModal) deleteChatModal.style.display = 'none';
                });
            }
            if (cancelDeleteChatBtn) {
                cancelDeleteChatBtn.addEventListener('click', () => {
                    if (deleteChatModal) deleteChatModal.style.display = 'none';
                });
            }
            if (confirmDeleteChatBtn) {
                confirmDeleteChatBtn.addEventListener('click', () => {
                    if (chatIdToDelete) {
                        deleteChat(chatIdToDelete);
                        chatIdToDelete = null; // Reset after deletion
                    }
                    if (deleteChatModal) deleteChatModal.style.display = 'none';
                });
            }
        });

       
    </script>
</body>

</html>
